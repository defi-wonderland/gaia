name: Deploy Hermes Processor

on:
  push:
    branches:
      - main
    paths:
      - 'hermes-processor/**'
      - 'hermes-schema/**'
      - 'mock-substream/**'
      - 'wire/**'
      - 'hermes/k8s/hermes-processor.yaml'
      - '.github/workflows/hermes-deploy.yml'

env:
  REGISTRY: registry.digitalocean.com/geo
  IMAGE_NAME: hermes-processor

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install doctl
        uses: digitalocean/action-doctl@v2
        with:
          token: ${{ secrets.DIGITALOCEAN_ACCESS_TOKEN }}

      - name: Log in to DigitalOcean Container Registry
        run: doctl registry login --expiry-seconds 1200

      - name: Build and push Docker image
        run: |
          docker build -t ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ github.sha }} \
                       -t ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:latest \
                       -f hermes-processor/Dockerfile .
          docker push ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ github.sha }}
          docker push ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:latest

      - name: Set up kubectl
        uses: azure/setup-kubectl@v4

      - name: Configure kubectl for DigitalOcean
        run: |
          doctl kubernetes cluster kubeconfig save ${{ secrets.DIGITALOCEAN_CLUSTER_NAME }}

      - name: Delete existing job (jobs are immutable)
        run: |
          kubectl delete job hermes-processor -n kafka --ignore-not-found=true

      - name: Apply k8s manifests
        run: |
          kubectl apply -f hermes/k8s/namespace.yaml
          kubectl apply -f hermes/k8s/hermes-processor.yaml

      - name: Wait for job to start
        run: |
          kubectl wait --for=condition=ready pod -l app=hermes-processor -n kafka --timeout=60s || true

      - name: Show deployment status
        run: |
          echo "=== Hermes Processor Job ==="
          kubectl get job hermes-processor -n kafka || echo "Job not found"
          echo ""
          echo "=== Hermes Processor Pods ==="
          kubectl get pods -n kafka -l app=hermes-processor
          echo ""
          echo "=== Recent Events ==="
          kubectl get events -n kafka --sort-by='.lastTimestamp' | tail -10
