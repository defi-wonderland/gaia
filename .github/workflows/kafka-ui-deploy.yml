name: Deploy Kafka UI

on:
  push:
    branches:
      - main
    paths:
      - 'hermes/k8s/kafka-ui.yaml'
      - 'hermes-schema/proto/**'
      - 'wire/proto/grc20.proto'
      - '.github/workflows/kafka-ui-deploy.yml'

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install doctl
        uses: digitalocean/action-doctl@v2
        with:
          token: ${{ secrets.DIGITALOCEAN_ACCESS_TOKEN }}

      - name: Set up kubectl
        uses: azure/setup-kubectl@v4

      - name: Configure kubectl for DigitalOcean
        run: |
          doctl kubernetes cluster kubeconfig save ${{ secrets.DIGITALOCEAN_CLUSTER_NAME }}

      - name: Apply k8s manifests
        run: |
          kubectl apply -f hermes/k8s/namespace.yaml
          kubectl create configmap protobuf-schemas \
            --from-file=grc20.proto=wire/proto/grc20.proto \
            --from-file=blockchain_metadata.proto=hermes-schema/proto/blockchain_metadata.proto \
            --from-file=knowledge.proto=hermes-schema/proto/knowledge.proto \
            --from-file=space.proto=hermes-schema/proto/space.proto \
            --from-file=topology.proto=hermes-schema/proto/topology.proto \
            --namespace=kafka \
            --dry-run=client -o yaml | kubectl apply -f -
          kubectl apply -f hermes/k8s/kafka-ui.yaml

      - name: Wait for deployment to be ready
        run: |
          kubectl rollout status deployment/kafka-ui -n kafka --timeout=120s

      - name: Show deployment status
        run: |
          echo "=== Kafka UI Deployment ==="
          kubectl get deployment kafka-ui -n kafka
          echo ""
          echo "=== Kafka UI Pods ==="
          kubectl get pods -n kafka -l app=kafka-ui
